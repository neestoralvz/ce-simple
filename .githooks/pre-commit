#!/bin/bash

# Pre-commit Hook for VDD Mandatory Verification
# Automatically validates mandatory verification before allowing commits
# Authority: user-input/technical-requirements/implementation-verification-mandatory-user.md

set -e

echo "üîç Running VDD MANDATORY Implementation Verification..."

# Run mandatory implementation verification
if [ -f "./scripts/validate-implementation-mandatory.sh" ]; then
    ./scripts/validate-implementation-mandatory.sh post-implementation
    verification_result=$?
    
    if [ $verification_result -eq 0 ]; then
        echo "‚úÖ Mandatory verification passed - commit allowed"
    else
        echo "‚ùå MANDATORY VERIFICATION FAILED - commit blocked"
        echo "‚ùå Gap detection triggered - re-planning required"
        echo "Authority: implementation-verification-mandatory-user.md"
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Mandatory verification script not found"
    echo "üîç Falling back to coherence validation..."
    
    # Fallback to coherence validation
    if [ -f "./scripts/validate-coherence.sh" ]; then
        ./scripts/validate-coherence.sh
        if [ $? -eq 0 ]; then
            echo "‚úÖ Coherence validation passed - commit allowed"
        else
            echo "‚ùå Coherence validation failed - commit blocked"
            exit 1
        fi
    else
        echo "‚ö†Ô∏è  No validation scripts found - commit allowed but verification skipped"
    fi
fi

# Additional PTS compliance checks for commands
echo "üîç Checking PTS compliance in commands..."

changed_commands=$(git diff --cached --name-only | grep "commands/.*\.md$" || true)

if [ -n "$changed_commands" ]; then
    echo "Validating changed commands: $changed_commands"
    
    for cmd in $changed_commands; do
        if [ -f "$cmd" ]; then
            echo "Checking $cmd..."
            
            # Check for 3-step maximum (Directness)
            step_count=$(grep -c "### Step [0-9]" "$cmd" 2>/dev/null || echo "0")
            if [ "$step_count" -gt 3 ]; then
                echo "‚ùå $cmd violates Directness (>3 steps: $step_count)"
                exit 1
            fi
            
            # Check for Task Tool references (Parallelization)
            if ! grep -q "Task Tool" "$cmd"; then
                echo "‚ùå $cmd missing Task Tool parallelization"
                exit 1
            fi
            
            # Check for external references (Self-containment)
            if grep -q "\.\./\|@.*\.md" "$cmd"; then
                echo "‚ùå $cmd contains external references (not self-contained)"
                exit 1
            fi
            
            echo "‚úÖ $cmd passes PTS compliance"
        fi
    done
else
    echo "No command files changed"
fi

echo "‚úÖ Pre-commit validation completed successfully"